<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function ratelockTicketEmails($scope, $timeout) {
  /* widget controller */
  var c = this;

  c.getEmailSrc = function (id) {
    return '/email_display.do?email_id=' + id;
  };

  c.toggleOpenEmailDetails = function (id, body) {
    if (id) {
      if ($scope.emailLinkOpen && $scope.emailLinkOpen === id) {
        $scope.emailLinkOpen = undefined;
        $timeout(function () {
          $scope.renderedEmailBody = '';
        }, 100);

      } else {

        $timeout(function () {
          $scope.emailLinkOpen = id;
        }, 200);

      }
    }
  };

  c.enableAdvanceEmailSearch = function () {
    $scope.emails = undefined;
    $scope.data.enable_advanced_search = true;
    $scope.isAdvancedSearchEnabled = true;
    $scope.isShowingTemplates = false;
    $scope.isHistoryReady = false;
    $scope.data.feed = c.feed;
    $scope.server.update().then(function (data) {
      if (data.emailEntries && angular.isArray(data.emailEntries)) {
        $scope.emails = data.emailEntries;
        $scope.data.enable_advanced_search = false;
      }
    });
  };

  c.isOpen = function (id) {
    if (!id || !$scope.emailLinkOpen) return false;
    return $scope.emailLinkOpen === id;
  };

  c.getEmailLinkHeadingText = function (id) {
    var msg = 'Show email details';
    if (!id || !$scope.emailLinkOpen) return msg;
    if ($scope.emailLinkOpen === id) {
      return 'Hide email details';
    }
    return msg;
  };
}]]></client_script>
        <controller_as>c</controller_as>
        <css>.list-header {&#13;
  margin-bottom: 10px;&#13;
  display: block;&#13;
  margin-top: 0px;&#13;
}&#13;
&#13;
.timeline .avatar-container {&#13;
  border: none;&#13;
}&#13;
&#13;
.no-email-records {&#13;
  padding: 60px;&#13;
  align-items: center;&#13;
  vertical-align: middle;&#13;
  justify-content: center;&#13;
  text-align: center;&#13;
&#13;
  &amp;:hover {&#13;
    &amp; span {&#13;
      text-decoration: underline;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.accordion-link {&#13;
&#13;
  &amp;:active,&#13;
  &amp;:focus {&#13;
    outline: none;&#13;
    border: none;&#13;
    box-shadow: none;&#13;
  }&#13;
}&#13;
&#13;
.panel-footer {&#13;
  &amp;.panel-sticky {&#13;
    position: sticky;&#13;
    bottom: 0;&#13;
    left: 0;&#13;
    z-index: 1001;&#13;
  }&#13;
}&#13;
&#13;
.form-group {&#13;
  &amp; div {&#13;
    &amp; .select2-container-multi {&#13;
      &amp; .select2-choices {&#13;
        border: none;&#13;
        border-bottom: 1px solid #bdc0c4;&#13;
        border-radius: 0px;&#13;
&#13;
        &amp;:focus,&#13;
        &amp;:active {&#13;
          outline: none;&#13;
          box-shadow: none;&#13;
        }&#13;
      }&#13;
    }&#13;
&#13;
    &amp; .select2-container-active,&#13;
    .select2-container-active .select2-choice,&#13;
    .select2-container-active .select2-choices {&#13;
      border: none;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.recipients-label {&#13;
  padding-left: 5px;&#13;
}&#13;
&#13;
.panel-title {&#13;
  display: inline;&#13;
}&#13;
&#13;
.panel-body {&#13;
  background-color: #fff;&#13;
}&#13;
&#13;
.btn.btn-link.active {&#13;
  color: $brand-primary;&#13;
}&#13;
&#13;
.panel {&#13;
  background-color: transparent !important;&#13;
}&#13;
&#13;
.btn-primary:focus {&#13;
  border: 1px solid $brand-primary;&#13;
  box-shadow: 0px 0px 5px $brand-primary;&#13;
}&#13;
&#13;
.form-control:focus {&#13;
  border-color: $brand-primary;&#13;
  outline: 4px solid transparent;&#13;
  outline: 5px auto transparent;&#13;
  -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(224, 58, 58, 0.6);&#13;
  box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(224, 58, 58, 0.6);&#13;
}&#13;
&#13;
.secondary-journal-field {&#13;
  border: 1px solid gold;&#13;
}&#13;
&#13;
.primary-journal-field {&#13;
  border: 1px solid #ccc;&#13;
}&#13;
&#13;
.panel-title-container {&#13;
  display: flex;&#13;
  justify-content: space-between;&#13;
  align-items: center;&#13;
}&#13;
&#13;
.panel-title-icons {&#13;
&#13;
  ul {&#13;
    display: flex;&#13;
    align-items: center;&#13;
    padding: 0;&#13;
    margin: 0;&#13;
  }&#13;
&#13;
  li {&#13;
    padding: 0;&#13;
    margin: 0;&#13;
&#13;
    .panel-button {&#13;
      display: flex;&#13;
      align-items: center;&#13;
      margin: 0 0 0 15px;&#13;
      line-height: initial;&#13;
&#13;
      &amp;:hover,&#13;
      &amp;:focus {&#13;
        border-color: transparent;&#13;
        outline: none;&#13;
        -webkit-box-shadow: inset 0 0px 0px rgba(0, 0, 0, .075), 0 0 0px rgba(224, 58, 58, 0.6);&#13;
        box-shadow: inset 0 0px 0px rgba(0, 0, 0, .075), 0 0 0px rgba(224, 58, 58, 0.6);&#13;
        text-decoration: none;&#13;
      }&#13;
&#13;
      &amp;:not(.active):focus {&#13;
        color: #000;&#13;
      }&#13;
&#13;
      &amp;:not(.btn-templates):hover {&#13;
        color: $brand-primary;&#13;
      }&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
&#13;
.timeline-heading test {&#13;
  float: right;&#13;
}&#13;
&#13;
.timeline-body&gt;p {&#13;
  white-space: pre-wrap;&#13;
  overflow-x: hidden;&#13;
}&#13;
&#13;
.timeline-body ul&gt;li {&#13;
  float: none;&#13;
}&#13;
&#13;
.input-group {&#13;
  .select2-choices {&#13;
    border-top-left-radius: 4px;&#13;
    border-top-right-radius: 0px;&#13;
    border-bottom-left-radius: 4px;&#13;
    border-bottom-right-radius: 0px;&#13;
  }&#13;
}&#13;
&#13;
.no-resize {&#13;
  resize: none;&#13;
}&#13;
&#13;
.journal-field-indicator {&#13;
  width: 5px;&#13;
  position: absolute;&#13;
  left: 5px;&#13;
  top: 5px;&#13;
  bottom: 5px;&#13;
  z-index: 3;&#13;
}&#13;
&#13;
.panel-heading {&#13;
  word-wrap: break-word;&#13;
}&#13;
&#13;
.avatar-container {&#13;
  cursor: default;&#13;
}&#13;
&#13;
ul {&#13;
  list-style: none;&#13;
}&#13;
&#13;
.overflow-hidden {&#13;
  overflow: hidden;&#13;
}&#13;
&#13;
&#13;
.timeline-badge-wrap {&#13;
  margin: auto;&#13;
  max-width: 115px;&#13;
}&#13;
&#13;
.timeline-badge.success {&#13;
  background-color: $success;&#13;
}&#13;
&#13;
.timeline-badge {&#13;
  position: relative;&#13;
  left: 25%;&#13;
  width: 50%;&#13;
  padding-bottom: 50%;&#13;
  border-radius: 50%;&#13;
}&#13;
&#13;
.timeline-badge span {&#13;
  position: absolute;&#13;
  top: 50%;&#13;
  left: 50%;&#13;
  transform: translate(-50%, -50%);&#13;
  font-size: 13px;&#13;
  color: #fff;&#13;
}&#13;
&#13;
.journal-type {&#13;
  display: inline-flex;&#13;
  display: -ms-inline-flexbox;&#13;
  flex-wrap: wrap;&#13;
  -webkit-justify-content: flex-end;&#13;
}&#13;
&#13;
.fa-circle {&#13;
  font-size: 4px;&#13;
  padding: 7px;&#13;
}&#13;
&#13;
@media (max-width: 768px) {&#13;
  .timeline-badge-wrap {&#13;
    margin: 0;&#13;
  }&#13;
&#13;
  .timeline-badge {&#13;
    left: 10%;&#13;
  }&#13;
}&#13;
&#13;
.list-group-clear {&#13;
  border: 1px solid transparent;&#13;
  border-radius: 0px;&#13;
}&#13;
&#13;
.email-frame {&#13;
  overflow-y: hidden;&#13;
&#13;
  &amp; .panel-body {&#13;
    overflow-y: hidden;&#13;
&#13;
    &amp; .email-details-inner {&#13;
      overflow-y: hidden;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.email-panel-body {&#13;
  padding-bottom: 5px;&#13;
}&#13;
&#13;
.email-title,&#13;
.email-details {&#13;
  color: rgb(69, 84, 100);&#13;
  font-size: 12px;&#13;
}&#13;
&#13;
.email-title {&#13;
  padding: 0px 0px 15px 0px;&#13;
}&#13;
&#13;
.email-display-name {&#13;
  margin-left: 5px;&#13;
}&#13;
&#13;
.message-created {&#13;
  display: inline-flex;&#13;
}&#13;
&#13;
.email-dot {&#13;
  background: rgba(69, 84, 100, 0.85);&#13;
  display: inline-block;&#13;
  height: 5px;&#13;
  width: 5px;&#13;
  border-radius: 50%;&#13;
  vertical-align: middle;&#13;
  margin: 6px 4px;&#13;
}&#13;
&#13;
.text-align-right {&#13;
  text-align: right;&#13;
}&#13;
&#13;
.email-details {&#13;
  display: -webkit-box;&#13;
  display: -moz-box;&#13;
  display: -ms-flexbox;&#13;
  display: -webkit-flex;&#13;
  align-items: center;&#13;
  vertical-align: middle;&#13;
  justify-content: center;&#13;
  padding-bottom: 5px;&#13;
&#13;
  &amp; .email-details-container {&#13;
    display: flex;&#13;
    width: 100%;&#13;
    align-items: center;&#13;
    justify-content: center;&#13;
    vertical-align: middle;&#13;
    overflow-y: hidden;&#13;
  }&#13;
}&#13;
&#13;
.email-panel {&#13;
  border-radius: 0px;&#13;
}&#13;
&#13;
iframe.card {&#13;
  border: none !important;&#13;
  overflow-y: hidden !important;&#13;
&#13;
  &amp; html {&#13;
    padding: 15px;&#13;
    overflow-y: hidden;&#13;
  }&#13;
}&#13;
&#13;
.emails-details-list-group {&#13;
  margin-bottom: 0px;&#13;
  max-width: 500px;&#13;
  width: 100%;&#13;
&#13;
  &amp; .emails-details-list-group-item {&#13;
    padding: 5px;&#13;
&#13;
    &amp; .email-details-link {&#13;
      color: $brand-primary;&#13;
&#13;
      &amp;:hover {&#13;
        text-decoration: underline;&#13;
      }&#13;
    }&#13;
&#13;
    &amp; .email-details-col:nth-child(1) {&#13;
      font-weight: 700;&#13;
    }&#13;
&#13;
    &amp; .email-details-col:nth-child(2) {&#13;
      word-break: break-all;&#13;
    }&#13;
&#13;
    &amp; .email-details-col.importance {&#13;
      color: $danger;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.panel-clear {&#13;
  &amp; .email-details-inner {&#13;
    justify-content: center;&#13;
    display: flex;&#13;
&#13;
    &amp;:first-child {&#13;
      border: 1px solid #ccc;&#13;
    }&#13;
  }&#13;
}&#13;
&#13;
.select2-container-active .select2-choice,&#13;
.select2-container-active .select2-choices {&#13;
  border: 1px solid $brand-primary;&#13;
}&#13;
&#13;
.select2-choice {&#13;
  &amp;:focus {&#13;
    border: 1px solid $brand-primary;&#13;
    box-shadow: 0px 0px 5px $brand-primary;&#13;
  }&#13;
}&#13;
&#13;
.loading {&#13;
  min-height: 400px;&#13;
  display: flex;&#13;
  width: 100%;&#13;
  vertical-align: middle;&#13;
  align-items: center;&#13;
  justify-content: center;&#13;
&#13;
  &amp;.absolute-loader {&#13;
    height: 100%;&#13;
    position: absolute;&#13;
    top: 0;&#13;
    left: 0;&#13;
    background: #fff;&#13;
    z-index: 1049;&#13;
  }&#13;
&#13;
  &amp; span.loading-inline {&#13;
    font-size: 3rem;&#13;
    font-weight: 700;&#13;
    color: $brand-primary;&#13;
  }&#13;
}&#13;
&#13;
.btn-absolute-group {&#13;
  position: absolute;&#13;
  top: 50px;&#13;
  left: 15px;&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>ratelock_ticket_emails</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Ratelock Ticket Emails</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {
  /* populate the 'data' object */
  /* e.g., data.table = $sp.getValue('table'); */
  gs.include('RatelockDateUtils');
  data.sys_id = (input ? input.sys_id : undefined) || options.sys_id || $sp.getParameter("sys_id");
  data.table = (input ? input.table : undefined) || options.table || $sp.getParameter("table");

  data.emails = getEmailRecords(data.table, data.sys_id, (input ? input.enable_advanced_search : false));

  function getEmailRecords(table, sysId, runAdvancedSearch) {
    var _entries = [];
    var gr = new GlideRecord('sys_email');
    if (runAdvancedSearch) {
      gr.addQuery('instance', sysId).addOrCondition('body', 'CONTAINS', 'Loan Ref:' + sysId);
    } else {
      gr.addQuery('instance', sysId)
    }

    gr.orderByDesc('sys_created_on');
    gr.query();

    while (gr.next()) {

      _entries.push({
        element: 'emails',
        field_label: 'Email',
        sys_created_on: RatelockDateUtils.formatDateTime(gr.sys_created_on),
        from: getCreatedBy(gr.user, gr.user_id),
        sys_id: gr.getUniqueValue(),
        type: getEmailType(gr.getValue('type')),
        to: gr.getValue('direct'),
        cc: gr.getValue('copied'),
        body: gr.getValue('body'),
        importance: gr.importance.nil() ? null : gr.getValue('importance'),
        subject: gr.getValue('subject')
      });
    }
    return _entries;
  }

  function getEmailType(type) {
    switch (type) {
      case 'sent':
        return 'Email Sent';
      case 'send-ready':
        return 'Processing';
      default:
        return 'Email Received';
    }
  }

  function getCreatedBy(from, user) {
    if (!user.nil()) {
      return user.getDisplayValue();
    } else if (from.nil()) {
      return 'System';
    } else {
      return from.getDisplayValue();
    }
  }
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>douglas.schamberg@movement.com</sys_created_by>
        <sys_created_on>2020-08-20 12:13:36</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>949a70f0dbb65c10f2551329689619d3</sys_id>
        <sys_mod_count>3</sys_mod_count>
        <sys_name>Ratelock Ticket Emails</sys_name>
        <sys_package display_value="Ratelock" source="x_momo_ratelock">605affb71badc01048a242e58d4bcb76</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="Ratelock">605affb71badc01048a242e58d4bcb76</sys_scope>
        <sys_update_name>sp_widget_949a70f0dbb65c10f2551329689619d3</sys_update_name>
        <sys_updated_by>douglas.schamberg@movement.com</sys_updated_by>
        <sys_updated_on>2020-08-28 14:36:50</sys_updated_on>
        <template><![CDATA[<div class="email-container padder">
  <div class="loading" ng-if="!data.emails">
    <span class="loading-inline">
      <i class="fa fa-spinner fa-spin" aria-hidden="true"></i>
    </span>
  </div>
  <ul class="list-group" ng-if="data.emails">
    <li class="list-group-item list-group-clear" ng-if="data.emails.length === 0">
      <div class="no-email-records">
        <span>${No email records found}</span>
      </div>
    </li>
    <li class="list-group-item list-group-clear" ng-repeat="record in data.emails" ng-if="data.emails.length > 0">
      <div class="panel panel-default m-b-none email-panel">
        <div class="panel-body email-panel-body">
          <div class="row email-title">
            <div class="col-md-6">
              <div class="email-title-avatar">
                <span class="email-display-name">{{ record.from }}</span>
              </div>
            </div>
            <div class="col-md-6 text-align-right">
              <span class="text-muted message-created" ng-bind="record.sys_created_on"></span>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="email-details">
                <div class="email-details-container">
                  <ul class="list-group emails-details-list-group m-b-none">
                    <li class="list-group-item list-group-clear emails-details-list-group-item">
                      <span class="email-details-col importance" ng-if="record.importance === 'high'"><i
                          class="fa fa-exclamation" aria-hidden="true"></i></span>
                      <span class="email-details-col" ng-if="!record.importance"><i class="icon-mail"></i>
                      </span>
                      <span class="email-details-col m-l-xs">{{ record.type }}</span>

                    </li>
                    <li class="list-group-item list-group-clear emails-details-list-group-item">
                      <span class="email-details-col">Subject: </span>
                      <span class="email-details-col">{{ record.subject }}</span>
                    </li>
                    <li class="list-group-item list-group-clear emails-details-list-group-item">
                      <span class="email-details-col">From: </span>
                      <span class="email-details-col" ng-if="record.user">{{ record.user }}</span>
                      <span class="email-details-col" ng-if="!record.user">{{ record.from }}</span>
                    </li>
                    <li class="list-group-item list-group-clear emails-details-list-group-item"
                      ng-if="(record.to && record.to !== '')">
                      <span class="email-details-col">To: </span>
                      <span class="email-details-col break-to">{{ record.to }}</span>
                    </li>
                    <li class="list-group-item list-group-clear emails-details-list-group-item"
                      ng-if="(record.cc && record.cc !== '')">
                      <span class="email-details-col">CC: </span>
                      <span class="email-details-col">{{ record.cc }}</span>
                    </li>
                    <li class="list-group-item list-group-clear emails-details-list-group-item">
                      <a href class="email-details-link accordion-toggle"
                        ng-click="c.toggleOpenEmailDetails(record.sys_id, record.body)">
                        <span class="email-details-link-text" ng-bind="c.getEmailLinkHeadingText(record.sys_id)"></span>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="panel-collapse collapse panel-clear email-frame" uib-collapse="!c.isOpen(record.sys_id)">
            <div class="panel-body">
              <div class="email-details-inner">
                <iframe loading="lazy" style="width:100%;overflow-y:hidden;" sp-frame-resize
                  is-showing="c.isOpen(record.sys_id)" allowfullscreen="false" allowpaymentrequest="false"
                  frameborder="0" ng-src="{{ c.getEmailSrc(record.sys_id) }}"></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>
    </li>
  </ul>
</div>]]></template>
    </sp_widget>
</record_update>
